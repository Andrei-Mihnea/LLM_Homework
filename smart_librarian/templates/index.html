<!-- templates/index.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Smart Librarian</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{
      --bg:#0b0d10; --panel:#11151b; --muted:#7d8896; --text:#e8edf2; --border:rgba(255,255,255,.06);
      --accent1:#7c99ff; --accent2:#6c86ff; --accent3:#5ae3b3;
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,Segoe UI,Inter,Arial;
      height:100vh;display:grid;grid-template-columns:280px 1fr;
    }

    .side{border-right:1px solid var(--border);background:#0f1216;height:100vh;display:flex;flex-direction:column}
    .side .top{padding:12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .btn{display:inline-block;padding:8px 10px;background:linear-gradient(135deg,var(--accent1),var(--accent2));color:#0b0d10;border-radius:10px;text-decoration:none;font-weight:700}
    .list{padding:10px;display:flex;flex-direction:column;gap:8px;overflow:auto}
    .row{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px}
    .row a{color:var(--accent3);text-decoration:none}
    .row small{color:var(--muted);display:block;margin-top:4px}
    .row form{margin-top:8px}
    .danger{padding:6px 8px;border-radius:8px;border:1px solid var(--border);background:#190e11;color:#ffb3c0;cursor:pointer}

    .main{height:100vh;display:flex;flex-direction:column}
    .bar{padding:10px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:#0f1216}
    .area{flex:1;display:flex;justify-content:center}
    .inner{width:min(900px,100%);padding:16px;display:flex;flex-direction:column;gap:10px;overflow-y:auto}
    .bubble{max-width:75%;padding:10px 12px;border-radius:14px;border:1px solid var(--border);line-height:1.5;white-space:pre-wrap}
    .user{align-self:flex-end;background:#0e1116}
    .assistant{align-self:flex-start;background:#141a23}
    .meta{font-size:12px;color:var(--muted);margin:4px 2px}

    .composer{padding:10px;border-top:1px solid var(--border);background:#10141a}
    form.chat{display:flex;gap:8px;align-items:flex-start}
    .field{flex:1;display:flex;flex-direction:column;gap:8px}
    .field label{font-size:12px;color:var(--muted)}
    input[type="text"]{flex:1;background:#0e1116;border:1px solid var(--border);border-radius:10px;color:var(--text);padding:10px}
    .actions{display:flex;gap:8px}
    button.send{padding:10px 12px;border-radius:10px;border:0;background:linear-gradient(135deg,var(--accent1),var(--accent2));color:#0b0d10;font-weight:800;cursor:pointer}

    .empty{opacity:.7;color:var(--muted);padding:24px;text-align:center}

    .nav-links{display:flex;gap:12px;align-items:center}
    .logout-btn{padding:6px 10px;border-radius:8px;background:#190e11;color:#ffb3c0;text-decoration:none;font-weight:600;border:1px solid var(--border)}
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="side">
    <div class="top">
      <strong>Chats</strong>
      <a class="btn" href="/home/new">+ New</a>
    </div>
    <div class="list">
      {% if conversations %}
        {% for c in conversations %}
          <div class="row">
            <a href="/home/open/{{ c.id }}">{{ c.title }}</a>
            <small>Updated {{ c.updated_at }}</small>
            <form action="/home/delete/{{ c.id }}" method="POST">
              <button class="danger" type="submit">Delete</button>
            </form>
          </div>
        {% endfor %}
      {% else %}
        <div class="row">No conversations yet.</div>
      {% endif %}
    </div>
  </aside>

  <!-- Main chat -->
  <main class="main">
    <div class="bar">
      <div>
        {% if current %}
          <span style="color:#9fb3c8">#{{ current.id }}</span>
          <span style="margin-left:6px">{{ current.title }}</span>
        {% else %}
          <span style="color:#9fb3c8">No chat selected</span>
        {% endif %}
      </div>
      <div class="nav-links">
        <a style="color:var(--accent3);text-decoration:none" href="/home/index">Home</a>
        <a class="logout-btn" href="/auth/logout">Logout</a>
      </div>
    </div>

    <div class="area">
      <div class="inner" id="scroll">
        {% if current and current.messages %}
          {% for m in current.messages %}
            <div class="meta">{{ loop.index }} · {{ m.role }}</div>
            <div class="bubble {% if m.role == 'user' %}user{% else %}assistant{% endif %}">{{ m.content }}</div>
          {% endfor %}
        {% else %}
          <div class="empty">Start a new chat or select one from the left.</div>
        {% endif %}
      </div>
    </div>

    <div class="composer">
      {% if current %}
        <!-- data-conv-id instead of action -->
        <form class="chat" data-conv-id="{{ current.id }}" method="POST" autocomplete="off">
          <div class="field" style="max-width:720px">
            <label for="message">Your message</label>
            <input id="message" type="text" name="message" placeholder="Ask for cozy fantasy with found family..." required />
          </div>
          <div class="actions">
            <button class="send" type="submit">Send</button>
          </div>
        </form>
      {% else %}
        <a class="btn" href="/home/new">Create your first chat</a>
      {% endif %}
    </div>
  </main>

  <script>
    const sc = document.getElementById('scroll');
    function autoscroll(){ if (sc) sc.scrollTop = sc.scrollHeight; }
    autoscroll();

    const form = document.querySelector('form.chat');
    const input = document.getElementById('message');

    function bubble(role, content, index){
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = `${index} · ${role}`;
      const div = document.createElement('div');
      div.className = 'bubble ' + (role === 'user' ? 'user' : 'assistant');
      div.textContent = content;
      return [meta, div];
    }

    function toast(msg){
      console.warn(msg);
      const t = document.createElement('div');
      t.style.position='fixed'; t.style.bottom='16px'; t.style.left='16px';
      t.style.padding='10px 14px'; t.style.background='#2b1d1f';
      t.style.color='#ffb3c0'; t.style.border='1px solid rgba(255,255,255,.08)';
      t.style.borderRadius='10px'; t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(()=>t.remove(), 2000);
    }

    if (form && input){
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        e.stopPropagation();

        const text = (input.value || '').trim();
        if (!text) return;

        const inner = document.querySelector('.inner');
        const convId = form.dataset.convId;

        // optimistic bubble
        const idx = inner.querySelectorAll('.bubble').length + 1;
        const [mu, bu] = bubble('user', text, idx);
        inner.appendChild(mu); inner.appendChild(bu);
        autoscroll();

        input.value = '';
        input.disabled = true;

        try {
          const res = await fetch(`/home/send/${encodeURIComponent(convId)}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ message: text })
          });
          
          const raw = await res.text();
          let data = null;
          try {
            data = JSON.parse(raw);
          } catch {
            console.error('Non-JSON response:', raw);
            toast('Send failed (non-JSON response)');
            return;
          }

          if (!res.ok || data.error) {
            toast(data.error || `Send failed (${res.status})`);
            return;
          }

          // assistant bubble
          const idx2 = inner.querySelectorAll('.bubble').length + 1;
          const [ma, ba] = bubble('assistant', data.assistant_reply, idx2);
          inner.appendChild(ma); inner.appendChild(ba);
          autoscroll();
        } catch (err){
          console.error(err);
          toast('Network error');
        } finally {
          input.disabled = false;
          input.focus();
        }
      }, { passive:false });
    }
  </script>
</body>
</html>
